**發明名稱：一種基於混合協議的大規模文件分發的方法和裝置**

**一、 發明目的**

**1.1解決的技術問題以及應用該發明的產品或項目：**

近十幾年，基於HTTP/HTTPS協議的文件分發取代FTP等協議，成爲主流的文件分發方式，該方式具備協議實現簡單、跨平臺兼容性好、併發下載等優點。但是隨着分發規模的擴大，傳統的基於HTTP/HTTPS的文件分發方法，當面臨當前億萬級別的分發規模時，遇到如下問題：

1. 對分發源站的壓力大，所有分發目的端均需要從源站下載完整文件，分發規模越大，對源站的壓力越大。
2. 帶寬費用高，目前帶寬通常有流量計費和峯值帶寬計費兩種模式。不管哪種模式，費用和分發規模以及文件大成正比，分發規模的擴大帶來成本的極速提高。
3. 分發速度慢，因爲源站帶寬和性能限制，分發速度是分發規模的反比，所以同樣隨着分發規模的擴大，分發速度大幅減慢。

爲解決在億萬級別規模的文件分發場景下的如上三個問題，本文設計了一種基於混合協議的大規模文件分發的方法以及裝置，並應用在公司內部變更系統部署包分發場景中，未來將會應用在雲存儲、網盤等場景，從而大幅節約成本，提高分發速度。

**1.2 現有技術的實現方案：**

現有技術爲解決如上三個問題，有三種實現方案：

1. CDN方案。其原理是將文件先分發到成百上千個CDN邊緣節點上，然後再就近分發到各個分發目的地端，從而降低源站壓力並提升分發速度。同時因爲邊緣節點的帶寬價格一般低於源站，所以也有一定的成本節約。CDN方案的優點是無需對原來的分發目的端進行修改，依然基於HTTP/HTTPS協議。
2. P2P 方案。P2P點對點協議的原理是將文件拆成固定大小的Block，然後讓已經下載到部分Block的分發目的端向其他尚未下載Block的分發目的端進行傳輸。從而不僅降低的源站壓力、節約源站帶寬，同時隨着分發規模擴大，分發速度反而予以提升。
3. Hybird P2P-CDN方案。P2P方案存在需要持續做種以及在部分網絡環境下被封禁限制的問題，故有Hybird P2P-CDN方案，即CDN節點除提供HTTP/HTTPS下載外，也作爲P2P的分發源持續做種，從而兼取CDN和P2P方案的優點。

**1.3 現有技術的缺點：**

|  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- |
| 技術方案 | 源站壓力 | 帶寬費用 | 分發速度 | 其他優點 | 其他缺點 |
| 直接源站下載 | 極高 | 極高 | 極低 | 協議簡單 | 無 |
| CDN方案 | 低 | 高 | 中 | 無需修改分發協議 | 依賴於CDN廠商的服務穩定性 |
| P2P方案 | 低 | 低 | 高 | 無 | 需要修改分發協議  需要源站持續做種機制  部分網絡環境兼容性差，下載成功率低  分發啓動速度較慢 |
| Hybird P2P-CDN方案 | 低 | 中 | 極高 | 適應多種網絡環境  分發啓動速度快  無需源站持續做種 | 需要修改分發協議  技術上依賴於CDN廠商解決方案，無法自主可控。  價格上依賴於CDN廠商的定價，成本高於P2P方案。 |
| 本文混合協議方案 | 低 | 低 | 高 | 除Hybird P2P-CDN方案優勢外，本文方案無需依賴於CDN廠商的解決方案，併兼容原有的任何服務商的CDN或者源站分發方式。  從而不僅下載成功率高、下載速度快外，成本也是方案中最低的。 | 需要修改分發協議 |

。

**二、發明內容（本發明技術方案的詳細闡述）**

* 1. **本發明提供的完整技術實現方案**

下面詳細描述本發明的實施例，實施例的示例在2.2附圖中示出。下面通過參考附圖描述的實施例是示例性的，旨在解釋本發明，而不能理解對本發明的限制。

如圖1所示，本發明實施例的大規模文件分發系統，包括如下組件：控制服務器1，多箇中繼服務器2，數據庫3和多個客戶端4。其中控制服器務1和數據庫3位於IDC機房或者雲平臺上；中繼服務器2可以位於IDC機房、雲平臺上，也可以位於CDN邊緣節點上；多個客戶端4位於分發目的端的計算機設備上。而文件分發的原始數據位於數據源服務器5上，我們將使用文件分發的用戶稱爲用戶0。

以一次典型的文件分發業務流程爲例，將整個流程拆分爲如下步驟（參見圖1）：

步驟一（圖例中的step1），用戶0向控制服務器1發送指令，要求將數據源服務器5上的文件分發到多個客戶端4上，並同時提供分發配置。

步驟二（step2），控制服務器1創建配套的中繼任務和分發任務，並持久化到數據庫3中。

步驟三（step3），控制服務器1將分發任務下發到目標的多個客戶端4上，並根據客戶端的分佈和數據，挑選多箇中繼服務器4，將中繼任務下發到這些中繼服務器4上。

步驟四（step4），中繼服務器2從數據源服務器4中拉取需要分發的目標文件，在拉取的同時提供HTTP協議和BitTorrent協議的數據下載服務。

步驟五（step5），客戶端4根據分發配置，和中繼服務器2以及其他的客戶端4組成BitTorrent下載網絡（簡稱BT協議）進行數據下載，如果因爲客戶端4所在網絡限制BT協議或者BT下載速度過慢，還可以輔以從中繼服務2或數據源服務器4上通過HTTP協議下載文件作爲BT協議的補充。分發過程中，客戶端4和控制服務器1進行交互，從而實現下載、上傳以及源服務器壓力的全局控制。

在上述各個步驟中，本發明實現了三處技術方案，從而讓本發明比其他文件分發有明顯的優勢。具體技術方案如下：

1. 客戶端下載速度和質量保證技術： 客戶端默認使用BT協議下載，當下載速度低於預設的配置值時，客戶端可以通過HTTP協議從中繼服務器2或數據源服務器4上進行輔助下載，從而保證下載速度滿足預設要求。
2. 數據源服務器4壓力精細化控制技術： 控制服務器1可以配置對數據源服務器4的全局下載併發數、下載帶寬、總下載流量。在下載過程中，控制服務器1向客戶端4分配併發度、帶寬、流量配額，從而保證全侷限製得到滿足。
3. 下載快啓動技術：在步驟四中，中繼服務器2從數據源服務器4中拉取需要分發的目標文件的同時，就可以提供數據流給客戶端4用於下載，所以客戶端4下載啓動時間較快。

**2.2 附圖說明**

**（爲了方便理解發明內容，請通過流程圖或者系統框圖的方式闡明技術方案的實現步驟或者結構。）**

**2.3 本技術方案對產品的幫助**

通過本技術方案，對大規模文件分發場景有如下幫助：

1. 對源站/CDN的壓力進行精細化控制，從而有效控制源站/CDN成本
2. 帶寬成本遠低於CDN方案，同時可以和CDN配合，精細控制帶寬比例，實現成本和分發效率的最佳平衡。
3. 平均下載速度、下載啓動速度均顯著高於其他方案，同時還可以提供最低下載速度保障。
4. 網絡環境兼容度高，兼容多種網絡。
5. 和CDN服務商無關，可配合任意CDN甚至無CDN的服務。可不對原分發網絡進行任何修改，旁路加速，從而讓分發技術方案切換的成本降到最低。

**2.4、針對2.1中的技術方案，是否還有別的替代方案同樣能完成發明目的，如有，請列出。**

參考1.2和1.3，現有技術方案的缺點已經列出。

**三、業界相關產品及現有技術檢索：**

**3.1 與該技術相關的競爭對手或相關產品：**

**（請列出競爭對手的名稱、相關產品的名稱，對於相關產品也可以採用截圖等方式）**

各CDN廠商，如阿里雲、網宿、騰訊雲等。

**3.2 相關現有技術，重點是已公開專利及科技論文**

**（如專利/論文/標準，可以用附件、鏈接、文獻名稱及出處等方式提供）**

* **請列出使用的中英文關鍵詞（或組合）：**

Hybird P2P CDN

Content Distribution

混合文件分發

* **跟本發明相關的現有專利或者論文名稱及鏈接：**
  + Xu, D., Kulkarni, S. S., Rosenberg, C., & Chai, H. K. (2006). Analysis of a CDN–P2P hybrid architecture for cost-effective streaming media distribution. *Multimedia Systems*, *11*(4), 383-399.
  + Jiang, H., Li, J., Li, Z., & Bai, X. (2009). Efficient large-scale content distribution with combination of CDN and P2P networks. *International Journal of Hybrid Information Technology*, *2*(2), 4.
  + El Dick, M., Pacitti, E., & Kemme, B. (2009, March). Flower-CDN: a hybrid P2P overlay for efficient query processing in CDN. In *Proceedings of the 12th International Conference on Extending Database Technology: Advances in Database Technology* (pp. 427-438).
  + Munther, A., Noori, S., Osman, A., Hussain, A., Jasim, I., & Shanoon, A. (2012). Peer-to-peer video conferencing using hybrid content distribution model. *Journal of Computer Science*, *8*(7), 1134.
  + Jiang, H., Li, J., Li, Z., & Bai, X. (2008, December). Performance evaluation of content distribution in hybrid CDN-P2P network. In *2008 Second International Conference on Future Generation Communication and Networking* (Vol. 1, pp. 188-193). IEEE.
  + Afergan, M. M., Leighton, F. T., & Parikh, J. G. (2012). *U.S. Patent No. 8,332,484*. Washington, DC: U.S. Patent and Trademark Office.

* **跟上述專利或者論文內容的核心區別點：**

見1.3，和Hybird P2P-CDN核心區別點是本文技術方案屬於旁路運行，和CDN服務商無強綁定；同時可以對帶寬進行精細控制，使成本低於 Hybird P2P-CDN 方案。