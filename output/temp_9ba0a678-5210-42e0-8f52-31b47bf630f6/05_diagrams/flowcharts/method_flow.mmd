```mermaid
graph TD
    subgraph "基于混合协议的大规模文件分发方法流程"
        S201[S201：接收分发请求<br/>用户通过Web界面或API发送文件分发请求]

        S202[S202：创建中继任务和分发任务<br/>控制服务器验证参数并创建任务]

        S203[S203：智能选择中继服务器<br/>根据客户端分布和网络质量选择最优中继服务器组合]

        S204[S204：下发分发任务<br/>向目标客户端推送分发任务]

        S205[S205：下发中继任务<br/>向选定的中继服务器发送中继任务]

        S206[S206：流式传输启动<br/>中继服务器边拉取边提供下载服务]

        S207[S207：组成BitTorrent下载网络<br/>客户端与中继服务器及其他客户端建立P2P网络]

        S208[S208：监测下载速度<br/>实时监测BitTorrent协议下载速度]

        S209{速度是否低于阈值？<br/>检测下载速度是否低于预设阈值}

        S210[S210：HTTP协议辅助下载<br/>向中继服务器或数据源服务器发起HTTP下载请求]

        S211[S211：数据整合与状态上报<br/>整合HTTP下载数据，上报下载完成状态]

        S212[S212：统计与优化<br/>收集统计信息，优化分发策略]
    end

    %% 主流程连接
    S201 --> S202
    S202 --> S203
    S203 --> S204
    S203 --> S205
    S204 --> S207
    S205 --> S206
    S206 --> S207
    S207 --> S208
    S208 --> S209
    S209 -->|是| S210
    S209 -->|否| S207
    S210 --> S211
    S211 --> S212

    %% 子流程细节
    subgraph "S202任务创建详情"
        S202_1[参数验证]
        S202_2[权限检查]
        S202_3[任务信息持久化]
        S202_1 --> S202_2 --> S202_3
    end

    subgraph "S206流式传输详情"
        S206_1[多线程并发拉取]
        S206_2[动态缓冲区管理]
        S206_3[启动条件检查]
        S206_4[开始提供服务]
        S206_1 --> S206_2 --> S206_3 --> S206_4
    end

    subgraph "S208速度监测详情"
        S208_1[滑动窗口统计]
        S208_2[多维度速度计算]
        S208_3[阈值比较判断]
        S208_1 --> S208_2 --> S208_3
    end

    subgraph "S210协议切换详情"
        S210_1[HTTP连接建立]
        S210_2[数据块选择]
        S210_3[分段下载]
        S210_4[数据校验整合]
        S210_1 --> S210_2 --> S210_3 --> S210_4
    end

    %% 详细流程连接
    S202 -.-> S202_1
    S206 -.-> S206_1
    S208 -.-> S208_1
    S210 -.-> S210_1

    %% 样式定义
    classDef startEnd fill:#4CAF50,color:#fff,stroke:#388E3C
    classDef process fill:#2196F3,color:#fff,stroke:#1976D2
    classDef decision fill:#FF9800,color:#fff,stroke:#F57C00
    classDef subProcess fill:#9C27B0,color:#fff,stroke:#7B1FA2

    class S201,S212 startEnd
    class S202,S203,S204,S205,S206,S207,S208,S210,S211 process
    class S209 decision
    class S202_1,S202_2,S202_3,S206_1,S206_2,S206_3,S206_4,S208_1,S208_2,S208_3,S210_1,S210_2,S210_3,S210_4 subProcess
```